<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
</head>
<body>
  <button onclick="createPicker()">Google Docs選択</button>

<script>
const CLIENT_ID = '653181018114-f2s9giig3d1gepb1u3fh8rpvv85v8bjm.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCNsc0oqympQTblz-0tB1xOsovnnVjKHEY';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyYqxoq8Vhk9AB9uYSg3RbBmImgiPQauJiyVniEu3HncTLe_Q-BSv-Y4p9ZST0e-AX3dA/exec";

    
let accessToken;

function initClient() {
  gapi.load("client:picker", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
    });
  });
}

initClient();

function createPicker() {
  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/drive.file",
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;

      const picker = new google.picker.PickerBuilder()
        .addView(google.picker.ViewId.DOCS)
        .setOAuthToken(accessToken)
        .setDeveloperKey(API_KEY)
        .setCallback(pickerCallback)
        .build();
      picker.setVisible(true);
    },
  });

  tokenClient.requestAccessToken();
}

async function pickerCallback(data) {
  if (data.action === google.picker.Action.PICKED) {
    const fileId = data.docs[0].id;
    const name = data.docs[0].name;

    // ① HTML取得
    const res = await fetch(
      `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=text/html`,
      {
        headers: { Authorization: `Bearer ${accessToken}` },
      }
    );

    const html = await res.text();

    // ② Markdown変換
    const turndownService = new TurndownService();
    const markdown = turndownService.turndown(html);

    // ③ GASへ保存依頼
    await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, markdown }),
    });

    alert("保存完了");
  }
}
</script>
</body>
</html>
